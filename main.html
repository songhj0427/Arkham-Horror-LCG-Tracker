<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Arkham Horror 조사자 추적기</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 1rem;
        background-color: #f4f4f4;
      }
      .controls {
        margin-bottom: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .reset-all-btn {
        background-color: #c0392b;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 6px 12px;
        cursor: pointer;
      }
      .investigator-area {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
      }
      .investigator {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        padding: 1rem;
        flex: 1;
        min-width: 200px;
        max-width: 300px;
        position: relative;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
      }
      .reset-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: #e74c3c;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 2px 8px;
        cursor: pointer;
      }
      .stat {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        gap: 0.5rem;
      }
      .stat label {
        flex: 1;
      }
      .stat .value {
        width: 2rem;
        text-align: center;
      }
      .stat button {
        width: 2rem;
      }
      .abilities {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        font-weight: bold;
        border: 1px solid #ccc;
        border-radius: 5px;
        overflow: hidden;
        box-sizing: border-box;
        width: 100%;
      }
      .abilities span {
        flex: 1;
        text-align: center;
        padding: 0.5rem;
        border-right: 1px solid #ccc;
        box-sizing: border-box;
      }
      .abilities span:last-child {
        border-right: none;
      }
      .investigator-select {
        margin-bottom: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .ability-description {
        margin-top: 0.5rem;
        font-size: 0.9rem;
        background: #f9f9f9;
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 0.5rem;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <div class="controls">
      <div>
        <label for="playerCount">인원 수 선택:</label>
        <select id="playerCount">
          <option value="1">1명</option>
          <option value="2">2명</option>
          <option value="3">3명</option>
          <option value="4">4명</option>
        </select>
        <button onclick="setupPlayers()">설정</button>
      </div>
      <button class="reset-all-btn" onclick="resetAllStats()">전체 리셋</button>
    </div>

    <div class="investigator-area" id="investigatorArea"></div>

    <script>
      const defaultStats = {
        health: 0,
        sanity: 0,
        clues: 0,
        actions: 3,
        willpower: 0,
        intellect: 0,
        combat: 0,
        agility: 0,
        ability: "",
      };
      const investigatorCodes = {
        "조이 사마라스": "02001",
        "로랜드 뱅크스": "01001",
        "데이지 워커": "01002",
        "위니프레드 해버먹": "60301",
      };

      async function fetchInvestigatorData(code) {
        const response = await fetch(
          `https://arkhamdb.com/api/public/card/${code}`,
          {
            headers: {
              "Accept-Language": "ko",
            },
          }
        );
        if (!response.ok) throw new Error(`API 요청 실패: ${response.status}`);
        return await response.json();
      }

      function createStatElement(name, label, value, idx) {
        return `<div class="stat"><label>${label}</label><button onclick="changeStat(${idx}, '${name}', -1)">-</button><span class="value" id="${name}-${idx}">${value}</span><button onclick="changeStat(${idx}, '${name}', 1)">+</button></div>`;
      }

      function updateInvestigatorStats(index, stats) {
        const card = document.getElementById(`investigator-${index}`);
        card.querySelector(".abilities").innerHTML = `
        <span>${stats.willpower}</span><span>${stats.intellect}</span><span>${stats.combat}</span><span>${stats.agility}</span>`;
        card.querySelector(`#health-${index}`).textContent = stats.health;
        card.querySelector(`#sanity-${index}`).textContent = stats.sanity;
        card.querySelector(`#clues-${index}`).textContent = stats.clues;
        card.querySelector(`#actions-${index}`).textContent = stats.actions;
        card.querySelector(`#ability-${index}`).textContent = stats.ability;
      }

      async function selectInvestigator(index) {
        const name = document.getElementById(
          `investigator-select-${index}`
        ).value;
        const code = investigatorCodes[name];
        try {
          const data = await fetchInvestigatorData(code);
          const stats = {
            willpower: data.skill_willpower,
            intellect: data.skill_intellect,
            combat: data.skill_combat,
            agility: data.skill_agility,
            health: data.health,
            sanity: data.sanity,
            clues: 0,
            actions: 3,
            ability: data.text || "",
          };
          localStorage.setItem(`investigator-${index}`, JSON.stringify(stats));
          updateInvestigatorStats(index, stats);
        } catch (e) {
          alert(e.message);
        }
      }

      function changeStat(index, stat, delta) {
        const elem = document.getElementById(`${stat}-${index}`);
        let value = parseInt(elem.textContent) + delta;
        if (value < 0) value = 0;
        elem.textContent = value;
        const saved = JSON.parse(
          localStorage.getItem(`investigator-${index}`)
        ) || { ...defaultStats };
        saved[stat] = value;
        localStorage.setItem(`investigator-${index}`, JSON.stringify(saved));
      }

      function resetStats(index) {
        const stats = { ...defaultStats, clues: 0, actions: 3 };
        localStorage.setItem(`investigator-${index}`, JSON.stringify(stats));
        updateInvestigatorStats(index, stats);
      }

      function resetAllStats() {
        const count = parseInt(document.getElementById("playerCount").value);
        for (let i = 0; i < count; i++) resetStats(i);
      }

      async function setupPlayers() {
        const count = parseInt(document.getElementById("playerCount").value);
        const area = document.getElementById("investigatorArea");
        area.innerHTML = "";
        for (let i = 0; i < count; i++) {
          const saved = JSON.parse(
            localStorage.getItem(`investigator-${i}`)
          ) || { ...defaultStats };
          const html = `
          <div class="investigator" id="investigator-${i}">
            <button class="reset-btn" onclick="resetStats(${i})">리셋</button>
            <h3>조사자 ${i + 1}</h3>
            <div class="investigator-select">
              <label>선택:</label>
              <select id="investigator-select-${i}" onchange="selectInvestigator(${i})">
                <option>조이 사마라스</option>
                <option>로랜드 뱅크스</option>
                <option>데이지 워커</option>
                <option>위니프레드 해버먹</option>
              </select>
            </div>
            <div class="abilities"><span>${saved.willpower}</span><span>${
            saved.intellect
          }</span><span>${saved.combat}</span><span>${
            saved.agility
          }</span></div>
            ${createStatElement("health", "체력", saved.health, i)}
            ${createStatElement("sanity", "정신력", saved.sanity, i)}
            ${createStatElement("clues", "단서", saved.clues, i)}
            ${createStatElement("actions", "행동 수", saved.actions, i)}
            <div class="ability-description" id="ability-${i}">${
            saved.ability
          }</div>
          </div>`;
          area.insertAdjacentHTML("beforeend", html);
          document.getElementById(`investigator-select-${i}`).value =
            Object.keys(investigatorCodes).find(
              (name) =>
                JSON.parse(localStorage.getItem(`investigator-${i}`))
                  ?.willpower === saved.willpower && name
            );
        }
      }

      window.onload = setupPlayers;
    </script>
  </body>
</html>
